<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="Jiaxin Shi">

  <title>KQA Pro Homepage</title>

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jointjs/2.1.0/joint.css" />

  <!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom fonts for this template -->
  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet'
    type='text/css'>
  <link
    href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
    rel='stylesheet' type='text/css'>

  <!-- Custom styles for this template -->
  <link href="css/clean-blog.min.css" rel="stylesheet">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QLKG3T9QJ2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-QLKG3T9QJ2');
  </script>
</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand" href="index.html">KQA Pro</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
        data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
        aria-label="Toggle navigation">
        Menu
        <i class="fas fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="leaderboard.html">Leaderboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="explore.html">Explore</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://arxiv.org/abs/2007.03875">Paper</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="demo.html">Demo</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Page Header -->
  <header class="masthead" style="background-image: url('img/数据集.jpg')">
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="site-heading">
            <h1>Demo</h1>
            <span class="subheading">We finetune a BART model using question-to-SPARQL and question-to-Program
              annotations of KQA Pro. Type any question that you want to ask about a knowledge base, and the
              automatically parsed SPARQL and Program will be displayed.</span>
          </div>
        </div>
      </div>
    </div>
  </header>


  <!-- Main Content -->
  <div class="container-fluid">
    <div class="block-light">
      <div class="row">
        <div class="col-md-6 mx-auto">
          <h1>Type your question here.</h1>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mx-auto" style="text-align: left; font-size: 15px;">
          <b style="font-size:20px;">Here are some examples that you could ask:</b><br>
          <ul>
            <li>Which one is longest among movies which were published in 1990?</li>
            <li>How many movies were published in America and in 1990?</li>
            <li>When did China join the WTO?</li>
            <li>How many scientists have won the Nobel award?</li>
            <li>Does the capital of China have a more than 20,000,000 population?</li>
            <li>How is Donald Trump related to Obama?</li>
            <li>Is Yao Ming taller than LeBron James or not?</li>
            <li>Where was the wife of LeBron James from?</li>
            <li>When did the area of China reach 9600000 square km?</li>
            <li>At which college did Hinton get his bachelor degree?</li>
            <li>Who is the next president after Donald Trump?</li>
            <li>......</li>
          </ul>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-6 col-md-8 col-sm-10 mx-auto">
          <div class="form-group">
            <textarea class="form-control" id="inputQuestion"
              rows="3">Which one is longest among movies which were published in 1990?</textarea>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mx-auto">
          <button id="parse" type="button" class="btn btn-info">Parse</button>
        </div>
      </div>

      <br>

      <div class="row">
        <div class="col-md-8 mx-auto">
          <h3>Predicted Program:</h3><canvas id='pred_program'> </canvas><br>
          <b id='pred_result_by_program'></b>
          <hr><br>
          <h3>Predicted SPARQL:</h3>
          <pre id="pred_sparql" class="code-center"> </pre>
          <b id='pred_result_by_sparql'></b>
        </div>
      </div>
    </div>
  </div>

  <hr>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <ul class="list-inline text-center">
            <!--             <li class="list-inline-item">
              <a href="#">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
            <li class="list-inline-item">
              <a href="#">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-facebook-f fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li> -->
            <li class="list-inline-item">
              <a href="#">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          </ul>
          <p class="copyright text-muted">Copyright &copy; THUKEG 2020</p>
        </div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap core JavaScript -->
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Custom scripts for this template -->
  <script src="js/clean-blog.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
  <script src="js/nomnoml.js"></script>

  <script type="text/javascript">

    function f_i(f, i) {
      return f + '-' + i;
    }

    function split_sparql(sparql) {
      var space = '    ';
      var clauses = [];
      var cur_dep = 0;
      for (var i = 0, j = 1; j < sparql.length - 1; j++) {
        var c = sparql.charAt(j)
        switch (c) {
          case '.':
            if (sparql.charAt(j - 1) == ' ' && sparql.charAt(j + 1) == ' ') {
              clauses.push(space.repeat(cur_dep) + sparql.substr(i, j - i + 1).trim());
              i = j + 1;
            }
            break
          case '{':
            if (sparql.charAt(j - 1) == ' ' && sparql.charAt(j + 1) == ' ') {
              clauses.push(space.repeat(cur_dep) + sparql.substr(i, j - i).trim());
              clauses.push(space.repeat(cur_dep) + '{');
              i = j + 1;
              cur_dep++;
            }
            break
          case '}':
            if (sparql.charAt(j - 1) == ' ' && sparql.charAt(j + 1) == ' ') {
              cur_dep--;
              clauses.push(space.repeat(cur_dep) + '}');
              i = j + 1;
            }
            break
          default:
            break
        }
      }
      if (j > i) clauses.push(sparql.substr(i, j - i + 1).trim());
      clauses = clauses.filter(w => w.trim().length > 0);
      var new_sparql = clauses.join('<br>');
      return new_sparql;
    }

    $("#parse").on("click", () => {

      document.getElementById("parse").innerHTML = "Parsing...";
      $('#parse').prop('disabled', true);

      var question = $("#inputQuestion").val();
      console.log(question);

      $.ajax({
        url: "http://166.111.68.66:6060/",  // server url
        data: { 'question': question },
        type: 'POST',
        success: function (resp) {
          var program = resp['program'];
          var sparql = resp['sparql'];
          var program_result = resp['program_result'];
          var sparql_result = resp['sparql_result'];

          // display program
          var desc = [];
          program.forEach((f, i) => {
            desc.push('[' + f_i(f['func'], i) + (f['inputs'].length > 0 ? ('|' + f['inputs'].join(';')) : '') + ']');
            f['dep'].forEach(j => {
              if (j >= 0) desc.push('[' + f_i(program[j]['func'], j) + ']->[' + f_i(f['func'], i) + ']');
            })
          })
          var source = desc.join(';\n');
          var conf = '#direction: right\n#fill: #8fd3e8\n';
          nomnoml.draw(document.getElementById('pred_program'), conf + source);

          // display sparql
          var sparql = sparql.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
          document.getElementById('pred_sparql').innerHTML = split_sparql(sparql);

          document.getElementById('pred_result_by_program').innerHTML = 'Answer: ' + program_result;
          document.getElementById('pred_result_by_sparql').innerHTML = 'Answer: ' + sparql_result;
        },
        error: function (o, status, error) {
          console.log('Error: ' + error);
        },
        complete: function () {
          document.getElementById("parse").innerHTML = "Parse";
          $('#parse').prop('disabled', false);
        }
      });
    });

  </script>
</body>

</html>